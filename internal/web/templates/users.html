{{define "content"}}
<div class="fade-in">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h1>Usu√°rios</h1>
            <p style="color: var(--text-secondary);">Gerenciar usu√°rios do sistema</p>
        </div>
        <button class="btn btn-primary" onclick="openUserModal('create')">‚ûï Novo Usu√°rio</button>
    </div>

    <!-- Filters -->
        <div class="card" style="margin-bottom: 2rem;">
            <form hx-get="/api/web/user/list/html" hx-target="#users-table" hx-trigger="submit">
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Buscar por UUID</label>
                    <input type="text" name="uuid" class="form-input" placeholder="UUID do usu√°rio">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Buscar por Email</label>
                    <input type="text" name="email" class="form-input" placeholder="email@exemplo.com">
                </div>
                <button type="submit" class="btn btn-secondary">üîç Buscar</button>
            </div>
        </form>
    </div>

    <!-- Users Table -->
    <div id="users-table" hx-get="/api/web/user/list/html" hx-trigger="load" hx-swap="innerHTML"></div>
</div>

<!-- Modal Create/Edit -->
<div id="user-modal" class="modal-backdrop" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 id="user-modal-title">Novo Usu√°rio</h3>
            <button class="modal-close" onclick="closeUserModal()">&times;</button>
        </div>
        <form id="user-form" hx-post="/api/web/user" hx-target="#users-table" hx-encoding="json" hx-swap="none"
            hx-on="htmx:afterRequest: if(event.detail.successful){ closeUserModal(); htmx.ajax('GET', '/api/web/user/list/html', {target: '#users-table', swap: 'innerHTML'}); }">
            <input type="hidden" id="user-uuid" name="uuid">

            <div class="form-group">
                <label class="form-label">Tenant *</label>
                <select name="tenant_identifier" id="user-tenant" class="form-select" required>
                    <option value="">Selecione um tenant...</option>
                    {{range .Tenants}}
                    <option value="{{.UUID}}">{{.Name}} - {{.Document}}</option>
                    {{end}}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Nome *</label>
                <input type="text" name="name" id="user-name" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label">Email *</label>
                <input type="email" name="email" id="user-email" class="form-input" required>
            </div>

            <div class="form-group" id="password-group">
                <label class="form-label">Senha *</label>
                <input type="password" name="password" id="user-password" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label">Role *</label>
                <select name="role" id="user-role" class="form-select" required>
                    <option value="admin">Admin</option>
                    <option value="user">User</option>
                    <option value="viewer">Viewer</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Status</label>
                <select name="live" id="user-live" class="form-select">
                    <option value="true">Ativo</option>
                    <option value="false">Inativo</option>
                </select>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openUserModal(action, data) {
        const modal = document.getElementById('user-modal');
        const form = document.getElementById('user-form');
        const title = document.getElementById('user-modal-title');
        const passwordGroup = document.getElementById('password-group');
        const passwordInput = document.getElementById('user-password');

        form.addEventListener('htmx:configRequest', function (event) {
            event.detail.parameters.live = document.getElementById('user-live').value === 'true';
        }, { once: true });

        if (action === 'create') {
            title.textContent = 'Novo Usu√°rio';
            form.reset();
            form.setAttribute('hx-post', '/api/web/user');
            form.removeAttribute('hx-patch');
            passwordInput.required = true;
            passwordGroup.style.display = 'block';
        } else if (action === 'edit' && data) {
            title.textContent = 'Editar Usu√°rio';
            document.getElementById('user-uuid').value = data.uuid;
            document.getElementById('user-tenant').value = data.tenant_uuid;
            document.getElementById('user-name').value = data.name;
            document.getElementById('user-email').value = data.email;
            document.getElementById('user-role').value = data.role;
            document.getElementById('user-live').value = String(data.live);
            form.setAttribute('hx-patch', `/api/web/user/${data.uuid}`);
            form.removeAttribute('hx-post');
            passwordInput.required = false;
            passwordGroup.style.display = 'none';
        }

        modal.style.display = 'flex';
        htmx.process(form);
    }

    function closeUserModal() {
        const form = document.getElementById('user-form');
        form.reset();
        form.setAttribute('hx-post', '/api/web/user');
        form.removeAttribute('hx-patch');
        document.getElementById('password-group').style.display = 'block';
        document.getElementById('user-password').required = true;
        document.getElementById('user-modal').style.display = 'none';
    }

    function deleteUser(uuid, name) {
        if (confirm(`Tem certeza que deseja excluir o usu√°rio "${name}"?`)) {
            fetch(`/api/web/user?uuid=${uuid}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        htmx.ajax('GET', '/api/web/user/list/html', { target: '#users-table', swap: 'innerHTML' });
                    }
                });
        }
    }
</script>
{{end}}